From: Lennart Poettering <lennart@poettering.net>
Date: Tue, 13 May 2014 16:35:34 +0200
Subject: pam_systemd: use F_DUPFD_CLOEXEC when dupping session fds

http://lists.freedesktop.org/archives/systemd-devel/2014-May/019034.html
(cherry picked from commit 85c08dc013f9f99b58bc9b79284af0b35304237b)
---
 src/login/pam-module.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/src/login/pam-module.c b/src/login/pam-module.c
index 195d4d57..3958db0c 100644
--- a/src/login/pam-module.c
+++ b/src/login/pam-module.c
@@ -475,7 +475,7 @@ _public_ PAM_EXTERN int pam_sm_open_session(
         }
 
         if (session_fd >= 0) {
-                session_fd = dup(session_fd);
+                session_fd = fcntl(session_fd, F_DUPFD_CLOEXEC, 3);
                 if (session_fd < 0) {
                         pam_syslog(handle, LOG_ERR, "Failed to dup session fd: %m");
                         return PAM_SESSION_ERR;
